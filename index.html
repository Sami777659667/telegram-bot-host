<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø¨Ø³ÙŠØ· */
        :root { --tg-theme-bg-color: #1e1e1e; --tg-theme-text-color: #ffffff; --tg-theme-button-color: #2481cc; --tg-theme-button-text-color: #ffffff; }
        body { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); font-family: sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 400px; margin: 0 auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #2c2c2c; color: #fff; box-sizing: border-box;}
        button { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: right;}
        h3 { margin-top: 0; font-size: 1rem; opacity: 0.9;}
        .note { font-size: 0.8rem; color: #aaa; margin-bottom: 10px; display: block;}
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ§  Ø§Ø³ØªØ¶Ø§ÙØ© Ø°ÙƒÙŠØ©</h2>
        
        <div class="card">
            <h3>1. ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª (Bot Token)</h3>
            <input type="text" id="botToken" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§">
        </div>

        <div class="card">
            <h3>2. Ù…Ù„Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ (JSON)</h3>
            <span class="note">Ø§Ø±ÙØ¹ Ù…Ù„Ù .json ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­.</span>
            <input type="file" id="rulesFile" accept=".json">
        </div>

        <button onclick="deployBot()">ğŸš€ Ø±ÙØ¹ ÙˆØªØ´ØºÙŠÙ„</button>
        <div id="log" style="margin-top: 20px; word-break: break-all;"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        async function deployBot() {
            const token = document.getElementById('botToken').value.trim();
            const fileInput = document.getElementById('rulesFile');
            const log = document.getElementById('log');

            if (!token) return log.innerText = "âŒ Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„ØªÙˆÙƒÙ†!";
            
            let rulesContent = null;
            if (fileInput.files.length > 0) {
                // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù ÙƒÙ†Øµ
                rulesContent = await fileInput.files[0].text();
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ JSON
                try { JSON.parse(rulesContent); } catch(e) { return log.innerText = "âŒ Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­!"; }
            }

            log.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªØ¬Ù‡ÙŠØ²...";

            try {
                const response = await fetch('/api/manager', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deploy', token: token, rules: rulesContent })
                });
                const data = await response.json();
                
                if (data.ok) {
                    log.innerText = `âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­!\n${rulesContent ? "Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ÙˆØ¯" : "Ø¨Ø¯ÙˆÙ† Ù…Ù„Ù Ø±Ø¯ÙˆØ¯ (Echo)"}`;
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    log.innerText = `âŒ Ø®Ø·Ø£: ${data.description || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`;
                }
            } catch (e) {
                log.innerText = `âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„: ${e.message}`;
            }
        }
    </script>
</body>
</html>
